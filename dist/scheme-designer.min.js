var SchemeDesigner;!function(t){var e=function(){function e(e,n){this.renderingRequestId=0,this.devicePixelRatio=1,this.defaultCursorStyle="default",this.objects=[],this.canvas=e,this.canvas2DContext=this.canvas.getContext("2d",{alpha:!1}),this.requestFrameAnimation=t.Polyfill.getRequestAnimationFrameFunction(),this.cancelFrameAnimation=t.Polyfill.getCancelAnimationFunction(),this.devicePixelRatio=t.Polyfill.getDevicePixelRatio(),this.scrollManager=new t.ScrollManager(this),this.zoomManager=new t.ZoomManager(this),this.eventManager=new t.EventManager(this),n&&(t.Tools.configure(this.scrollManager,n.scroll),t.Tools.configure(this.zoomManager,n.zoom)),this.disableCanvasSelection(),this.eventManager.bindEvents()}return e.prototype.getEventManager=function(){return this.eventManager},e.prototype.getScrollManager=function(){return this.scrollManager},e.prototype.getZoomManager=function(){return this.zoomManager},e.prototype.requestFrameAnimationApply=function(t){return this.requestFrameAnimation.apply(window,[t])},e.prototype.cancelAnimationFrameApply=function(t){return this.cancelFrameAnimation.apply(window,[t])},e.prototype.clearContext=function(){return this.canvas2DContext.clearRect(0,0,this.canvas.width/this.zoomManager.getScale(),this.canvas.height/this.zoomManager.getScale()),this},e.prototype.requestRenderAll=function(){var t=this;return this.renderingRequestId||(this.renderingRequestId=this.requestFrameAnimationApply(function(){t.renderAll()})),this},e.prototype.renderAll=function(){this.renderingRequestId&&(this.cancelAnimationFrameApply(this.renderingRequestId),this.renderingRequestId=0),this.eventManager.sendEvent("beforeRenderAll"),this.clearContext();for(var t=0,e=this.objects;t<e.length;t++){e[t].render(this)}this.eventManager.sendEvent("afterRenderAll")},e.prototype.addObject=function(t){this.objects.push(t),this.reCalcObjectsBoundingRect()},e.prototype.removeObject=function(t){this.objects.filter(function(e){return e!==t}),this.reCalcObjectsBoundingRect()},e.prototype.removeObjects=function(){this.objects=[]},e.prototype.getCanvas=function(){return this.canvas},e.prototype.getCanvas2DContext=function(){return this.canvas2DContext},e.prototype.setCursorStyle=function(t){return this.canvas.style.cursor=t,this},e.prototype.findObjectsByCoordinates=function(t){var e=[],n=t.x,o=t.y;n/=this.zoomManager.getScale(),o/=this.zoomManager.getScale(),n-=this.scrollManager.getScrollLeft(),o-=this.scrollManager.getScrollTop();for(var i=0,s=this.objects;i<s.length;i++){var r=s[i],a=r.getBoundingRect();a.left<=n&&a.right>=n&&a.top<=o&&a.bottom>=o&&e.push(r)}return e},e.prototype.getObjects=function(){return this.objects},e.prototype.getDefaultCursorStyle=function(){return this.defaultCursorStyle},e.prototype.getObjectsBoundingRect=function(){return this.objectsBoundingRect||(this.objectsBoundingRect=this.calculateObjectsBoundingRect()),this.objectsBoundingRect},e.prototype.reCalcObjectsBoundingRect=function(){this.objectsBoundingRect=null},e.prototype.calculateObjectsBoundingRect=function(){for(var t,e,n,o,i=0,s=this.objects;i<s.length;i++){var r=s[i].getBoundingRect();(null==t||r.top<t)&&(t=r.top),(null==e||r.left<e)&&(e=r.left),(null==n||r.right>n)&&(n=r.right),(null==o||r.bottom>o)&&(o=r.bottom)}return{left:e,top:t,right:n,bottom:o}},e.prototype.disableCanvasSelection=function(){for(var t=0,e=["-webkit-touch-callout","-webkit-user-select","-khtml-user-select","-moz-user-select","-ms-user-select","user-select","outline"];t<e.length;t++){var n=e[t];this.canvas.style[n]="none"}},e}();t.Scheme=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(t){this.isHovered=!1,this.isSelected=!1,this.cursorStyle="pointer",this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.renderFunction=t.renderFunction,t.cursorStyle&&(this.cursorStyle=t.cursorStyle),this.params=t}return t.prototype.render=function(t){this.renderFunction(this,t)},t.prototype.click=function(t,e){},t.prototype.mouseOver=function(t,e){},t.prototype.mouseLeave=function(t,e){},t.prototype.getBoundingRect=function(){return{left:this.x,top:this.y,right:this.x+this.width,bottom:this.y+this.height}},t}();t.SchemeObject=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(){}return t.getRequestAnimationFrameFunction=function(){for(var t=0,e=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"];t<e.length;t++){var n=e[t];if(window.hasOwnProperty(n))return window[n]}return function(t){return window.setTimeout(t,1e3/60)}},t.getCancelAnimationFunction=function(){return window.cancelAnimationFrame||window.clearTimeout},t.getDevicePixelRatio=function(){for(var t=0,e=["devicePixelRatio","webkitDevicePixelRatio","mozDevicePixelRatio"];t<e.length;t++){var n=e[t];if(window.hasOwnProperty(n))return window[n]}return 1},t}();t.Polyfill=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(){}return t.configure=function(e,n){if(n)for(var o in n){var i=n[o],s="set"+t.capitalizeFirstLetter(o);"function"==typeof e[s]&&e[s].apply(e,[i])}},t.capitalizeFirstLetter=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},t}();t.Tools=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(t){this.isDragging=!1,this.leftButtonDown=!1,this.hoveredObjects=[],this.scheme=t,this.setLastClientPosition({x:this.scheme.getCanvas().width/2,y:this.scheme.getCanvas().height/2})}return t.prototype.bindEvents=function(){var t=this;this.scheme.getCanvas().addEventListener("mousedown",function(e){t.onMouseDown(e)}),this.scheme.getCanvas().addEventListener("mouseup",function(e){t.onMouseUp(e)}),this.scheme.getCanvas().addEventListener("click",function(e){t.onClick(e)}),this.scheme.getCanvas().addEventListener("dblclick",function(e){t.onDoubleClick(e)}),this.scheme.getCanvas().addEventListener("mousemove",function(e){t.onMouseMove(e)}),this.scheme.getCanvas().addEventListener("mouseout",function(e){t.onMouseOut(e)}),this.scheme.getCanvas().addEventListener("mouseenter",function(e){t.onMouseEnter(e)}),this.scheme.getCanvas().addEventListener("contextmenu",function(e){t.onContextMenu(e)}),this.scheme.getCanvas().addEventListener("mousewheel",function(e){t.onMouseWheel(e)}),this.scheme.getCanvas().addEventListener("touchstart",function(e){t.onMouseDown(e)}),this.scheme.getCanvas().addEventListener("touchmove",function(e){t.onMouseMove(e)}),this.scheme.getCanvas().addEventListener("touchend",function(e){t.onMouseUp(e)}),this.scheme.getCanvas().addEventListener("touchcancel",function(e){t.onMouseUp(e)})},t.prototype.onMouseDown=function(t){this.leftButtonDown=!0,this.setLastClientPositionFromEvent(t)},t.prototype.onMouseUp=function(t){var e=this;this.leftButtonDown=!1,this.setLastClientPositionFromEvent(t),this.isDragging&&this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),setTimeout(function(){e.isDragging=!1},50)},t.prototype.onClick=function(t){if(!this.isDragging){for(var e=this.findObjectsForEvent(t),n=0,o=e;n<o.length;n++){var i=o[n];i.isSelected=!i.isSelected,this.sendEvent("clickOnObject",i)}e.length&&this.scheme.requestRenderAll()}},t.prototype.onDoubleClick=function(t){this.scheme.getZoomManager().zoomToPointer(t,14)},t.prototype.onContextMenu=function(t){},t.prototype.onMouseMove=function(t){if(this.leftButtonDown){var e=this.getCoordinatesFromEvent(t),n=Math.abs(e.x-this.getLastClientX()),o=Math.abs(e.y-this.getLastClientY());(n>1||o>1)&&(this.isDragging=!0,this.scheme.setCursorStyle("move"))}this.isDragging?this.scheme.getScrollManager().handleDragging(t):this.handleHover(t)},t.prototype.getPointer=function(t,e){var n="touchend"===t.type?"changedTouches":"touches",o=t;return o[n]&&o[n][0]?o[n][0][e]:o[e]},t.prototype.handleHover=function(t){this.setLastClientPositionFromEvent(t);var e=this.findObjectsForEvent(t),n=!1,o=!1;if(this.hoveredObjects.length)for(var i=0,s=this.hoveredObjects;i<s.length;i++){for(var r=s[i],a=!1,c=0,h=e;c<h.length;c++){(g=h[c])==r&&(a=!0)}a||(r.isHovered=!1,this.sendEvent("mouseLeaveObject",r),n=!0,o=!0)}if(!this.hoveredObjects.length||o)for(var l=0,u=e;l<u.length;l++){var g;(g=u[l]).isHovered=!0,n=!0,this.scheme.setCursorStyle(g.cursorStyle),this.sendEvent("mouseOverObject",g)}this.hoveredObjects=e,e.length||this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),n&&this.scheme.requestRenderAll()},t.prototype.onMouseOut=function(t){this.setLastClientPositionFromEvent(t),this.leftButtonDown=!1,this.isDragging=!1,this.scheme.requestRenderAll()},t.prototype.onMouseEnter=function(t){},t.prototype.onMouseWheel=function(t){return this.scheme.getZoomManager().handleMouseWheel(t)},t.prototype.setLastClientPositionFromEvent=function(t){var e=this.getCoordinatesFromEvent(t);this.setLastClientPosition(e)},t.prototype.findObjectsForEvent=function(t){var e=this.getCoordinatesFromEvent(t);return this.scheme.findObjectsByCoordinates(e)},t.prototype.getCoordinatesFromEvent=function(t){var e=this.scheme.getCanvas().getBoundingClientRect();return{x:this.getPointer(t,"clientX")-e.left,y:this.getPointer(t,"clientY")-e.top}},t.prototype.setLastClientPosition=function(t){this.lastClientPosition=t},t.prototype.getLastClientX=function(){return this.lastClientPosition.x},t.prototype.getLastClientY=function(){return this.lastClientPosition.y},t.prototype.sendEvent=function(t,e){var n="schemeDesigner."+t;if("function"==typeof CustomEvent){var o=new CustomEvent(n,{detail:e});this.scheme.getCanvas().dispatchEvent(o)}else{var i=document.createEvent("CustomEvent");i.initCustomEvent(n,!1,!1,e),this.scheme.getCanvas().dispatchEvent(i)}},t}();t.EventManager=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(t){this.scrollLeft=0,this.scrollTop=0,this.maxHiddenPart=.85,this.scheme=t}return t.prototype.getScrollLeft=function(){return this.scrollLeft},t.prototype.getScrollTop=function(){return this.scrollTop},t.prototype.scroll=function(t,e){var n=this.scheme.getObjectsBoundingRect(),o=this.scheme.getCanvas().width/this.scheme.getZoomManager().getScale()-n.left,i=this.scheme.getCanvas().height/this.scheme.getZoomManager().getScale()-n.top,s=-n.right,r=-n.bottom;t>(o*=this.maxHiddenPart)&&(t=o),e>(i*=this.maxHiddenPart)&&(e=i),t<(s*=this.maxHiddenPart)&&(t=s),e<(r*=this.maxHiddenPart)&&(e=r),this.scrollLeft=t,this.scrollTop=e,this.scheme.requestRenderAll()},t.prototype.toCenter=function(){var t=this.scheme.getObjectsBoundingRect(),e=(t.right-t.left)*this.scheme.getZoomManager().getScale(),n=(t.bottom-t.top)*this.scheme.getZoomManager().getScale(),o=this.scheme.getCanvas().width-e,i=this.scheme.getCanvas().height-n,s=o/2/this.scheme.getZoomManager().getScale(),r=i/2/this.scheme.getZoomManager().getScale();s-=t.left,r-=t.top,this.scroll(s,r)},t.prototype.handleDragging=function(t){var e=this.scheme.getEventManager().getLastClientX(),n=this.scheme.getEventManager().getLastClientY();this.scheme.getEventManager().setLastClientPositionFromEvent(t);var o=this.scheme.getEventManager().getLastClientX()-e,i=this.scheme.getEventManager().getLastClientY()-n;o/=this.scheme.getZoomManager().getScale(),i/=this.scheme.getZoomManager().getScale();var s=o+this.getScrollLeft(),r=i+this.getScrollTop();this.scroll(s,r)},t.prototype.setMaxHiddenPart=function(t){this.maxHiddenPart=t},t}();t.ScrollManager=e}(SchemeDesigner||(SchemeDesigner={})),function(t){var e=function(){function t(t){this.scale=1,this.zoomCoefficient=1.04,this.padding=.1,this.maxScale=5,this.scheme=t}return t.prototype.zoom=function(t){var e=Math.pow(this.zoomCoefficient,t);return this.zoomByFactor(e)},t.prototype.setScale=function(t){var e=this.scale/t;return this.zoomByFactor(e)},t.prototype.getScaleWithAllObjects=function(){var t=this.scheme.getObjectsBoundingRect(),e=(t.right-t.left)*(this.padding+1)/this.scheme.getCanvas().width,n=(t.bottom-t.top)*(this.padding+1)/this.scheme.getCanvas().height;return e>n?e:n},t.prototype.zoomByFactor=function(t){var e=this.scheme.getObjectsBoundingRect(),n=!0,o=!0,i=this.scale*t;return t<1?(n=this.scheme.getCanvas().width*(1-this.padding)<e.right*i,o=this.scheme.getCanvas().height*(1-this.padding)<e.bottom*i):(n=this.scheme.getCanvas().width*this.maxScale>e.right*i,o=this.scheme.getCanvas().height*this.maxScale>e.bottom*i),!(!n&&!o)&&(this.scheme.getCanvas2DContext().scale(t,t),this.scale=i,this.scheme.requestRenderAll(),!0)},t.prototype.getScale=function(){return this.scale},t.prototype.handleMouseWheel=function(t){var e=t.wheelDelta?t.wheelDelta/40:t.detail?-t.detail:0;return e&&this.zoomToPointer(t,e),t.preventDefault()&&!1},t.prototype.zoomToPointer=function(t,e){var n=this.scheme.getZoomManager().getScale(),o=this.scheme.getZoomManager().zoom(e);if(this.scheme.getEventManager().setLastClientPositionFromEvent(t),o){var i=this.scheme.getZoomManager().getScale(),s=this.scheme.getEventManager().getLastClientX()/n,r=this.scheme.getEventManager().getLastClientY()/n,a=this.scheme.getEventManager().getLastClientX()/i-s,c=this.scheme.getEventManager().getLastClientY()/i-r;this.scheme.getScrollManager().scroll(this.scheme.getScrollManager().getScrollLeft()+a,this.scheme.getScrollManager().getScrollTop()+c)}},t.prototype.setPadding=function(t){this.padding=t},t.prototype.setMaxScale=function(t){this.maxScale=t},t.prototype.setZoomCoefficient=function(t){this.zoomCoefficient=t},t}();t.ZoomManager=e}(SchemeDesigner||(SchemeDesigner={}));