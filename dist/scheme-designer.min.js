var SchemeDesigner;!function(e){var t=function(){function t(t,n){this.renderingRequestId=0,this.devicePixelRatio=1,this.defaultCursorStyle="default",this.canvas=t,this.canvas2DContext=this.canvas.getContext("2d",{alpha:!1}),this.requestFrameAnimation=e.Polyfill.getRequestAnimationFrameFunction(),this.cancelFrameAnimation=e.Polyfill.getCancelAnimationFunction(),this.devicePixelRatio=e.Polyfill.getDevicePixelRatio(),this.scrollManager=new e.ScrollManager(this),this.zoomManager=new e.ZoomManager(this),this.eventManager=new e.EventManager(this),this.storageManager=new e.StorageManager(this),n&&(e.Tools.configure(this.scrollManager,n.scroll),e.Tools.configure(this.zoomManager,n.zoom),e.Tools.configure(this.storageManager,n.storage)),this.disableCanvasSelection(),this.eventManager.bindEvents()}return t.prototype.getEventManager=function(){return this.eventManager},t.prototype.getScrollManager=function(){return this.scrollManager},t.prototype.getZoomManager=function(){return this.zoomManager},t.prototype.getStorageManager=function(){return this.storageManager},t.prototype.requestFrameAnimationApply=function(e){return this.requestFrameAnimation.apply(window,[e])},t.prototype.cancelAnimationFrameApply=function(e){return this.cancelFrameAnimation.apply(window,[e])},t.prototype.clearContext=function(){return this.canvas2DContext.clearRect(0,0,this.canvas.width/this.zoomManager.getScale(),this.canvas.height/this.zoomManager.getScale()),this},t.prototype.requestRenderAll=function(){var e=this;return this.renderingRequestId||(this.renderingRequestId=this.requestFrameAnimationApply(function(){e.renderAll()})),this},t.prototype.render=function(){this.requestRenderAll(),this.storageManager.getTree(),this.getZoomManager().setScale(this.zoomManager.getScaleWithAllObjects()),this.getScrollManager().toCenter()},t.prototype.renderAll=function(){this.renderingRequestId&&(this.cancelAnimationFrameApply(this.renderingRequestId),this.renderingRequestId=0),this.eventManager.sendEvent("beforeRenderAll"),this.clearContext();for(var e=0,t=this.storageManager.getObjects();e<t.length;e++){t[e].render(this)}this.eventManager.sendEvent("afterRenderAll")},t.prototype.addObject=function(e){this.storageManager.addObject(e)},t.prototype.removeObject=function(e){this.storageManager.removeObject(e)},t.prototype.removeObjects=function(){this.storageManager.removeObjects()},t.prototype.getCanvas=function(){return this.canvas},t.prototype.getCanvas2DContext=function(){return this.canvas2DContext},t.prototype.setCursorStyle=function(e){return this.canvas.style.cursor=e,this},t.prototype.getObjects=function(){return this.storageManager.getObjects()},t.prototype.getDefaultCursorStyle=function(){return this.defaultCursorStyle},t.prototype.disableCanvasSelection=function(){for(var e=0,t=["-webkit-touch-callout","-webkit-user-select","-khtml-user-select","-moz-user-select","-ms-user-select","user-select","outline"];e<t.length;e++){var n=t[e];this.canvas.style[n]="none"}},t}();e.Scheme=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(e){this.isHovered=!1,this.isSelected=!1,this.cursorStyle="pointer",this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this.renderFunction=e.renderFunction,e.cursorStyle&&(this.cursorStyle=e.cursorStyle),this.params=e}return e.prototype.render=function(e){this.renderFunction(this,e)},e.prototype.click=function(e,t){},e.prototype.mouseOver=function(e,t){},e.prototype.mouseLeave=function(e,t){},e.prototype.getBoundingRect=function(){return{left:this.x,top:this.y,right:this.x+this.width,bottom:this.y+this.height}},e}();e.SchemeObject=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(){}return e.getRequestAnimationFrameFunction=function(){for(var e=0,t=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"];e<t.length;e++){var n=t[e];if(window.hasOwnProperty(n))return window[n]}return function(e){return window.setTimeout(e,1e3/60)}},e.getCancelAnimationFunction=function(){return window.cancelAnimationFrame||window.clearTimeout},e.getDevicePixelRatio=function(){for(var e=0,t=["devicePixelRatio","webkitDevicePixelRatio","mozDevicePixelRatio"];e<t.length;e++){var n=t[e];if(window.hasOwnProperty(n))return window[n]}return 1},e}();e.Polyfill=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(){}return e.configure=function(t,n){if(n)for(var o in n){var i=n[o],s="set"+e.capitalizeFirstLetter(o);"function"==typeof t[s]&&t[s].apply(t,[i])}},e.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},e.clone=function(e){return JSON.parse(JSON.stringify(e))},e.pointInRect=function(e,t){var n=!1;return t.left<=e.x&&t.right>=e.x&&t.top<=e.y&&t.bottom>=e.y&&(n=!0),n},e.filterObjectsByBoundingRect=function(t,n){for(var o=[],i=0,s=n;i<s.length;i++){var r=s[i],a=r.getBoundingRect(),c=!1;e.pointInRect({x:a.left,y:a.top},t)?c=!0:e.pointInRect({x:a.right,y:a.top},t)?c=!0:e.pointInRect({x:a.left,y:a.bottom},t)?c=!0:e.pointInRect({x:a.right,y:a.bottom},t)&&(c=!0),c&&o.push(r)}return o},e}();e.Tools=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(e){this.isDragging=!1,this.leftButtonDown=!1,this.hoveredObjects=[],this.scheme=e,this.setLastClientPosition({x:this.scheme.getCanvas().width/2,y:this.scheme.getCanvas().height/2})}return e.prototype.bindEvents=function(){var e=this;this.scheme.getCanvas().addEventListener("mousedown",function(t){e.onMouseDown(t)}),this.scheme.getCanvas().addEventListener("mouseup",function(t){e.onMouseUp(t)}),this.scheme.getCanvas().addEventListener("click",function(t){e.onClick(t)}),this.scheme.getCanvas().addEventListener("dblclick",function(t){e.onDoubleClick(t)}),this.scheme.getCanvas().addEventListener("mousemove",function(t){e.onMouseMove(t)}),this.scheme.getCanvas().addEventListener("mouseout",function(t){e.onMouseOut(t)}),this.scheme.getCanvas().addEventListener("mouseenter",function(t){e.onMouseEnter(t)}),this.scheme.getCanvas().addEventListener("contextmenu",function(t){e.onContextMenu(t)}),this.scheme.getCanvas().addEventListener("mousewheel",function(t){e.onMouseWheel(t)}),this.scheme.getCanvas().addEventListener("touchstart",function(t){e.onMouseDown(t)}),this.scheme.getCanvas().addEventListener("touchmove",function(t){e.onMouseMove(t)}),this.scheme.getCanvas().addEventListener("touchend",function(t){e.onMouseUp(t)}),this.scheme.getCanvas().addEventListener("touchcancel",function(t){e.onMouseUp(t)})},e.prototype.onMouseDown=function(e){this.leftButtonDown=!0,this.setLastClientPositionFromEvent(e)},e.prototype.onMouseUp=function(e){var t=this;this.leftButtonDown=!1,this.setLastClientPositionFromEvent(e),this.isDragging&&this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),setTimeout(function(){t.isDragging=!1},50)},e.prototype.onClick=function(e){if(!this.isDragging){for(var t=this.findObjectsForEvent(e),n=0,o=t;n<o.length;n++){var i=o[n];i.isSelected=!i.isSelected,this.sendEvent("clickOnObject",i)}t.length&&this.scheme.requestRenderAll()}},e.prototype.onDoubleClick=function(e){this.scheme.getZoomManager().zoomToPointer(e,14)},e.prototype.onContextMenu=function(e){},e.prototype.onMouseMove=function(e){if(this.leftButtonDown){var t=this.getCoordinatesFromEvent(e),n=Math.abs(t.x-this.getLastClientX()),o=Math.abs(t.y-this.getLastClientY());(n>1||o>1)&&(this.isDragging=!0,this.scheme.setCursorStyle("move"))}this.isDragging?this.scheme.getScrollManager().handleDragging(e):this.handleHover(e)},e.prototype.getPointer=function(e,t){var n="touchend"===e.type?"changedTouches":"touches",o=e;return o[n]&&o[n][0]?o[n][0][t]:o[t]},e.prototype.handleHover=function(e){this.setLastClientPositionFromEvent(e);var t=this.findObjectsForEvent(e),n=!1,o=!1;if(this.hoveredObjects.length)for(var i=0,s=this.hoveredObjects;i<s.length;i++){for(var r=s[i],a=!1,c=0,h=t;c<h.length;c++){(u=h[c])==r&&(a=!0)}a||(r.isHovered=!1,this.sendEvent("mouseLeaveObject",r),n=!0,o=!0)}if(!this.hoveredObjects.length||o)for(var g=0,l=t;g<l.length;g++){var u;(u=l[g]).isHovered=!0,n=!0,this.scheme.setCursorStyle(u.cursorStyle),this.sendEvent("mouseOverObject",u)}this.hoveredObjects=t,t.length||this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),n&&this.scheme.requestRenderAll()},e.prototype.onMouseOut=function(e){this.setLastClientPositionFromEvent(e),this.leftButtonDown=!1,this.isDragging=!1,this.scheme.requestRenderAll()},e.prototype.onMouseEnter=function(e){},e.prototype.onMouseWheel=function(e){return this.scheme.getZoomManager().handleMouseWheel(e)},e.prototype.setLastClientPositionFromEvent=function(e){var t=this.getCoordinatesFromEvent(e);this.setLastClientPosition(t)},e.prototype.findObjectsForEvent=function(e){var t=this.getCoordinatesFromEvent(e);return this.scheme.getStorageManager().findObjectsByCoordinates(t)},e.prototype.getCoordinatesFromEvent=function(e){var t=this.scheme.getCanvas().getBoundingClientRect();return{x:this.getPointer(e,"clientX")-t.left,y:this.getPointer(e,"clientY")-t.top}},e.prototype.setLastClientPosition=function(e){this.lastClientPosition=e},e.prototype.getLastClientX=function(){return this.lastClientPosition.x},e.prototype.getLastClientY=function(){return this.lastClientPosition.y},e.prototype.sendEvent=function(e,t){var n="schemeDesigner."+e;if("function"==typeof CustomEvent){var o=new CustomEvent(n,{detail:t});this.scheme.getCanvas().dispatchEvent(o)}else{var i=document.createEvent("CustomEvent");i.initCustomEvent(n,!1,!1,t),this.scheme.getCanvas().dispatchEvent(i)}},e}();e.EventManager=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(e){this.scrollLeft=0,this.scrollTop=0,this.maxHiddenPart=.85,this.scheme=e}return e.prototype.getScrollLeft=function(){return this.scrollLeft},e.prototype.getScrollTop=function(){return this.scrollTop},e.prototype.scroll=function(e,t){var n=this.scheme.getStorageManager().getObjectsBoundingRect(),o=this.scheme.getZoomManager().getScale(),i=this.scheme.getCanvas().width/o-n.left,s=this.scheme.getCanvas().height/o-n.top,r=-n.right,a=-n.bottom;e>(i*=this.maxHiddenPart)&&(e=i),t>(s*=this.maxHiddenPart)&&(t=s),e<(r*=this.maxHiddenPart)&&(e=r),t<(a*=this.maxHiddenPart)&&(t=a),this.scrollLeft=e,this.scrollTop=t,this.scheme.requestRenderAll()},e.prototype.toCenter=function(){var e=this.scheme.getStorageManager().getObjectsBoundingRect(),t=(e.right-e.left)*this.scheme.getZoomManager().getScale(),n=(e.bottom-e.top)*this.scheme.getZoomManager().getScale(),o=this.scheme.getCanvas().width-t,i=this.scheme.getCanvas().height-n,s=o/2/this.scheme.getZoomManager().getScale(),r=i/2/this.scheme.getZoomManager().getScale();s-=e.left,r-=e.top,this.scroll(s,r)},e.prototype.handleDragging=function(e){var t=this.scheme.getEventManager().getLastClientX(),n=this.scheme.getEventManager().getLastClientY();this.scheme.getEventManager().setLastClientPositionFromEvent(e);var o=this.scheme.getEventManager().getLastClientX()-t,i=this.scheme.getEventManager().getLastClientY()-n;o/=this.scheme.getZoomManager().getScale(),i/=this.scheme.getZoomManager().getScale();var s=o+this.getScrollLeft(),r=i+this.getScrollTop();this.scroll(s,r)},e.prototype.setMaxHiddenPart=function(e){this.maxHiddenPart=e},e}();e.ScrollManager=t}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function t(e){this.treeDepth=6,this.scheme=e,this.objects=[]}return t.prototype.getObjects=function(){return this.objects},t.prototype.addObject=function(e){this.objects.push(e),this.reCalcObjectsBoundingRect(),this.requestBuildTree()},t.prototype.removeObject=function(e){this.objects.filter(function(t){return t!==e}),this.reCalcObjectsBoundingRect(),this.requestBuildTree()},t.prototype.removeObjects=function(){this.objects=[],this.requestBuildTree()},t.prototype.findObjectsByCoordinates=function(t){var n=[],o=t.x,i=t.y;o/=this.scheme.getZoomManager().getScale(),i/=this.scheme.getZoomManager().getScale(),o-=this.scheme.getScrollManager().getScrollLeft(),i-=this.scheme.getScrollManager().getScrollTop();for(var s=[],r=0,a=this.getTree().getLastChildren();r<a.length;r++){var c=a[r];if(e.Tools.pointInRect({x:o,y:i},c.getBoundingRect())){s=c.getObjects();break}}for(var h=0,g=s;h<g.length;h++){var l=g[h],u=l.getBoundingRect();e.Tools.pointInRect({x:o,y:i},u)&&n.push(l)}return n},t.prototype.getObjectsBoundingRect=function(){return this.objectsBoundingRect||(this.objectsBoundingRect=this.calculateObjectsBoundingRect()),this.objectsBoundingRect},t.prototype.reCalcObjectsBoundingRect=function(){this.objectsBoundingRect=null},t.prototype.calculateObjectsBoundingRect=function(){for(var e,t,n,o,i=0,s=this.objects;i<s.length;i++){var r=s[i].getBoundingRect();(null==e||r.top<e)&&(e=r.top),(null==t||r.left<t)&&(t=r.left),(null==n||r.right>n)&&(n=r.right),(null==o||r.bottom>o)&&(o=r.bottom)}return{left:t,top:e,right:n,bottom:o}},t.prototype.setTreeDepth=function(e){this.treeDepth=e},t.prototype.requestBuildTree=function(){this.rootTreeNode=null},t.prototype.getTree=function(){return this.rootTreeNode||(this.rootTreeNode=this.buildTree()),this.rootTreeNode},t.prototype.buildTree=function(){var e=this.getObjectsBoundingRect();return this.rootTreeNode=new n(null,e,this.objects,0),this.explodeTreeNodes(this.rootTreeNode,this.treeDepth),this.rootTreeNode},t.prototype.explodeTreeNodes=function(e,t){if(this.explodeTreeNode(e),--t>0)for(var n=0,o=e.getChildren();n<o.length;n++){var i=o[n];this.explodeTreeNodes(i,t)}},t.prototype.explodeTreeNode=function(t){var o=t.getBoundingRect(),i=t.getDepth()+1,s=e.Tools.clone(o),r=e.Tools.clone(o);if(i%2==1){var a=(o.right-o.left)/2;s.right=s.right-a,r.left=r.left+a}else{a=(o.bottom-o.top)/2;s.bottom=s.bottom-a,r.top=r.top+a}var c=e.Tools.filterObjectsByBoundingRect(s,t.getObjects()),h=e.Tools.filterObjectsByBoundingRect(r,t.getObjects()),g=new n(t,s,c,i),l=new n(t,r,h,i);t.addChild(g),t.addChild(l),t.removeObjects()},t.prototype.showNodesParts=function(){for(var e=this.getTree().getLastChildren(),t=this.scheme.getCanvas2DContext(),n=0,o=e;n<o.length;n++){var i=o[n],s=i.getBoundingRect().left+this.scheme.getScrollManager().getScrollLeft(),r=i.getBoundingRect().top+this.scheme.getScrollManager().getScrollTop(),a=i.getBoundingRect().right-i.getBoundingRect().left,c=i.getBoundingRect().bottom-i.getBoundingRect().top;t.lineWidth=1,t.strokeStyle="black",t.rect(s,r,a,c),t.stroke()}},t}();e.StorageManager=t;var n=function(){function e(e,t,n,o){this.children=[],this.objects=[],this.parent=e,this.boundingRect=t,this.objects=n,this.depth=o}return e.prototype.addChild=function(e){this.children.push(e)},e.prototype.getObjects=function(){return this.objects},e.prototype.getChildren=function(){return this.children},e.prototype.isLastNode=function(){return this.objects.length>0},e.prototype.getLastChildren=function(){for(var e=[],t=0,n=this.children;t<n.length;t++){var o=n[t];if(o.isLastNode())e.push(o);else for(var i=0,s=o.getLastChildren();i<s.length;i++){var r=s[i];e.push(r)}}return e},e.prototype.removeObjects=function(){this.objects=[]},e.prototype.getBoundingRect=function(){return this.boundingRect},e.prototype.getDepth=function(){return this.depth},e}();e.TreeNode=n}(SchemeDesigner||(SchemeDesigner={})),function(e){var t=function(){function e(e){this.scale=1,this.zoomCoefficient=1.04,this.padding=.1,this.maxScale=5,this.scheme=e}return e.prototype.zoom=function(e){var t=Math.pow(this.zoomCoefficient,e);return this.zoomByFactor(t)},e.prototype.setScale=function(e){var t=this.scale/e;return this.zoomByFactor(t)},e.prototype.getScaleWithAllObjects=function(){var e=this.scheme.getStorageManager().getObjectsBoundingRect(),t=(e.right-e.left)*(this.padding+1)/this.scheme.getCanvas().width,n=(e.bottom-e.top)*(this.padding+1)/this.scheme.getCanvas().height;return t>n?t:n},e.prototype.zoomByFactor=function(e){var t=this.scheme.getStorageManager().getObjectsBoundingRect(),n=!0,o=!0,i=this.scale*e;return e<1?(n=this.scheme.getCanvas().width*(1-this.padding)<t.right*i,o=this.scheme.getCanvas().height*(1-this.padding)<t.bottom*i):(n=this.scheme.getCanvas().width*this.maxScale>t.right*i,o=this.scheme.getCanvas().height*this.maxScale>t.bottom*i),!(!n&&!o)&&(this.scheme.getCanvas2DContext().scale(e,e),this.scale=i,this.scheme.requestRenderAll(),!0)},e.prototype.getScale=function(){return this.scale},e.prototype.handleMouseWheel=function(e){var t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return t&&this.zoomToPointer(e,t),e.preventDefault()&&!1},e.prototype.zoomToPointer=function(e,t){var n=this.scheme.getZoomManager().getScale(),o=this.scheme.getZoomManager().zoom(t);if(this.scheme.getEventManager().setLastClientPositionFromEvent(e),o){var i=this.scheme.getZoomManager().getScale(),s=this.scheme.getEventManager().getLastClientX()/n,r=this.scheme.getEventManager().getLastClientY()/n,a=this.scheme.getEventManager().getLastClientX()/i-s,c=this.scheme.getEventManager().getLastClientY()/i-r;this.scheme.getScrollManager().scroll(this.scheme.getScrollManager().getScrollLeft()+a,this.scheme.getScrollManager().getScrollTop()+c)}},e.prototype.setPadding=function(e){this.padding=e},e.prototype.setMaxScale=function(e){this.maxScale=e},e.prototype.setZoomCoefficient=function(e){this.zoomCoefficient=e},e}();e.ZoomManager=t}(SchemeDesigner||(SchemeDesigner={}));